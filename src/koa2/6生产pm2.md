---
title: 生产环境PM2运行
order: 6
article: false
category:
  - Nodejs 
  - koa
tag:
  - koa
---

在生产环境中，使用 PM2 运行。

关于为什么要用 PM2 ，以及 PM2 的安装，[看这里](https://www.npmjs.com/package/pm2)

## 配置

PM2 基本配置，和日志分割。

安装好 PM2 后，执行 `pm2 init`, 应该会自动生成一个 ``pm2.conf.json`` 的文件，如果没有就自己创建一个。

```json
{
  "apps": {
    "name": "mp-wx-server",
    // 程序入口
    "script": "bin/www",
    "watch": false,
    // 这个貌似是进程数
    "instances": 1,
    // 日志
    "error_file": "logs/err.log",
    "out_file": "logs/out.log",
    // 日志格式
    "log_date_format": "YYYY-MM-DD HH:mm:ss",
    "merge_logs": true
  }
}
```

这么配置，日志会按天分割。每天的日志都会单独的弄一个文件夹。

进程数和其他，自己看着配置就行。

配置好了之后，可以在 `package.json` 里面添加一个 `script`:

```json
{
  "prod": "cross-env NODE_ENV=production pm2 start pm2.conf.json"
}
```

## 常用命令

- ``pm2 start [bin]``  启动进程
- `pm2 stop [processid]` 结束进程
- `pm2 stop all` 结束所有进程
- `pm2 delete [processid]` 删除进程
- `pm2 delete all` 删除所有进程
- `pm2 list` 列出所有进程
- `pm2 restart [processid]` 重新启动进程
- `pm2 restart all` 重新启动所有进程
- `pm2 logs [processid]` 查看某个进程/应用的日志
- `pm2 logs` 查看pm2的日志
- `pm2 monit` 查看进程/应用的资源消耗情况
