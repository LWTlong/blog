---
title: 前端CSRF
order: 2
#article: false
category:
  - web安全
tag:
  - CSRF
---

## CSRF

CSRF（Cross - Site Request Forgery），即跨站请求伪造，也被称为 “One Click Attack” 或者 Session Riding，是一种常见的前端安全漏洞。

## 定义与原理

CSRF 攻击是指攻击者诱导用户访问一个恶意网站，在用户不知情的情况下，利用用户在目标网站已登录的身份信息，以用户的名义向目标网站发送恶意请求，执行一些用户本不希望执行的操作，如转账、修改密码、发布恶意内容等。

其原理是利用了浏览器的 Cookie 自动发送机制以及网站对用户身份的信任。

当用户登录到一个网站后，浏览器会保存该网站的 Cookie，其中包含用户的身份认证信息等。当用户访问其他网站时，如果该网站向目标网站发送请求，浏览器会自动带上目标网站的 Cookie，目标网站根据 Cookie 中的信息认为请求是合法用户发送的，从而执行相应的操作，而不会验证请求是否真的是用户自愿发起的。


## 攻击流程

1. 用户登录目标网站：用户在浏览器中登录到一个信任的网站 A，网站 A 验证用户身份并在用户的浏览器中设置了包含用户身份信息的 Cookie。

2. 用户访问恶意网站：用户在未退出网站 A 的情况下，访问了恶意网站 B。

3. 恶意网站发起攻击：恶意网站 B 通过 HTML 标签（如`<img>`、`<form>`等）或者 JavaScript 脚本等方式，向网站 A 发送请求，这些请求会携带用户在网站 A 的 Cookie 信息。

4. 目标网站执行请求：网站 A 收到请求后，根据 Cookie 中的用户身份信息，认为是合法用户的请求，从而执行相应的操作，如转账、修改用户信息等，而用户并不知道这些操作是在自己不知情的情况下被执行的。

例如： 

1. 假设用户 Alice 在银行网站bank.example.com上登录了自己的账户，进行网上银行操作。此时，浏览器中保存了银行网站的 Cookie，其中包含了 Alice 的登录凭证等信息。

2. 攻击者创建了一个恶意网站evil.example.com，在该网站上有一段恶意代码，代码中包含了一个隐藏的表单，表单的action属性指向银行网站的转账接口bank.example.com/transfer，表单的字段中设置了转账的金额、收款账号等信息。

3. 当 Alice 访问恶意网站evil.example.com时，恶意代码会自动提交这个隐藏的表单，由于浏览器会自动带上银行网站的 Cookie，银行网站收到请求后，会认为是 Alice 本人发起的转账请求，从而执行转账操作，将 Alice 账户中的资金转到攻击者指定的账户中。


## 防御措施

### 验证请求来源

* **Origin 头部验证**: 浏览器在发送跨域请求时，会自动带上 `Origin` 头部，该头部标识了请求的来源域名。服务器可以验证 `Origin` 头部的值，只允许来自合法域名的请求访问。


### cookie 设置 SameSite 属性

`SameSite` 是 Cookie 的一个属性，用于控制 Cookie 在跨站请求中的发送行为。通过设置 `SameSite` 属性，可以限制 Cookie 只能在同站请求中发送，从而防止跨站请求伪造攻击。

* `Strict`：最严格的模式，Cookie 只能在同站请求中发送，即只有当请求的域名与设置 Cookie 的域名完全相同时，才会发送 Cookie。

* `Lax`：相对宽松的模式，在大多数情况下，Cookie 只能在同站请求中发送，但对于一些简单的跨站请求（如链接跳转、GET 请求等），也会发送 Cookie。

* `None`：允许在所有情况下发送 Cookie，包括跨站请求。但需要同时设置Secure属性，即只能通过 HTTPS 协议发送 Cookie。


>[!warning]
> `SameSite` 需要同时设置 `Secure` 属性。            
> **Secure 属性**: 当设置了 Secure 属性时，Cookie 只会通过 HTTPS 连接发送到服务器，而不会通过 HTTP 连接发送。              
> 所以简单来说，只有在 https 协议下才可以使用。    


关于 cookie 的更多安全策略看[cookie](https://www.anbc.cn/blog/JavaScript/10%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%AD%98%E5%82%A8/1cookie.html)